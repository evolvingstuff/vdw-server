{% extends 'pages/base.html' %}

{% block title %}{{ page.title }} - VitaminDWiki{% endblock %}

{% block content %}
<article>
    <h1>{{ page.title }}</h1>
    
    <div class="post-meta">
        Created {{ page.created_date|date:"F Y" }}
        {% if page.modified_date != page.created_date %}
            • Updated {{ page.modified_date|date:"F d, Y" }}
        {% endif %}
    </div>

    <nav class="post-toc" id="post-toc" style="margin: 1.5em 0 2em 0; padding: 1em; background: #f8f9fa; border: 1px solid #e1e5e9; border-radius: 8px; display: none;">
        <div style="font-size: 0.9em; font-weight: 600; color: #666; margin-bottom: 0.75em; text-transform: uppercase; letter-spacing: 0.5px;">On this page</div>
        <ul id="toc-list" style="margin: 0; padding: 0; list-style: none;"></ul>
    </nav>

    <div class="markdown-content">
        {{ page.content_html|safe }}
    </div>
    
    {% if page.tags.all %}
    <div class="tags">
        <strong>Tags:</strong>
        {% for tag in page.tags.all %}
        <a href="{% url 'tag_pages' tag.slug %}" class="tag">{{ tag.name }}</a>
        {% endfor %}
    </div>
    {% endif %}
 </article>

<script>
(function() {
    function initTOC() {
        const contentEl = document.querySelector('.markdown-content');
        const tocContainer = document.getElementById('post-toc');
        const tocList = document.getElementById('toc-list');

        if (!contentEl || !tocContainer || !tocList) return;

        const headings = contentEl.querySelectorAll('h1, h2, h3, h4, h5, h6');
        if (headings.length === 0) {
            tocContainer.style.display = 'none';
            return;
        }

        const headingLevels = Array.from(headings).map(h => {
            const numeric = parseInt(h.tagName.substring(1), 10);
            return Number.isNaN(numeric) ? null : numeric;
        }).filter(level => level !== null);

        const uniqueLevels = Array.from(new Set(headingLevels)).sort((a, b) => a - b);
        const levelDepthLookup = new Map();
        uniqueLevels.forEach((level, depth) => {
            levelDepthLookup.set(level, depth);
        });

        headings.forEach((heading, index) => {
            if (!heading.id) {
                const text = heading.textContent || '';
                const slug = text.toLowerCase().trim()
                    .replace(/[^\w\s-]/g, '').replace(/\s+/g, '-')
                    .replace(/-+/g, '-').replace(/^-+|-+$/g, '');
                heading.id = slug || 'heading-' + index;
            }

            const li = document.createElement('li');
            li.style.cssText = 'margin: 0.4em 0; padding: 0 0 0 1.5em; position: relative;';

            const bullet = document.createElement('span');
            bullet.textContent = '•';
            bullet.setAttribute('aria-hidden', 'true');
            bullet.style.cssText = 'position: absolute; left: 0; top: 0.45em; transform: translateY(-50%); color: #3498db; font-size: 1em;';
            li.appendChild(bullet);

            const headingLevel = parseInt(heading.tagName.substring(1), 10);
            const depth = levelDepthLookup.get(headingLevel) ?? 0;

            const link = document.createElement('a');
            link.href = '#' + heading.id;
            link.textContent = heading.textContent;
            link.style.cssText = 'color: #3498db; text-decoration: none; display: inline-block;';
            link.style.fontWeight = depth === 0 ? '600' : '400';
            link.style.fontStyle = depth >= 2 ? 'italic' : 'normal';
            link.style.setProperty(
                'font-size',
                depth === 0 ? '1.12em' : (depth >= 2 ? '0.86em' : '0.96em'),
                'important'
            );

            link.addEventListener('click', function(e) {
                e.preventDefault();
                const navBar = document.getElementById('global-search-bar');
                const offset = (navBar ? navBar.offsetHeight : 0) + 12;
                const targetPos = heading.getBoundingClientRect().top + window.pageYOffset - offset;
                window.scrollTo({ top: targetPos, behavior: 'smooth' });
                if (history.pushState) history.pushState(null, null, '#' + heading.id);
            });

            li.appendChild(link);
            tocList.appendChild(li);
        });

        tocContainer.style.display = 'block';
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTOC);
    } else {
        initTOC();
    }
})();
</script>
{% endblock %}
