{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'posts/css/markdown-content.css' %}">
<style>
    /* Normal stacked view */
    .markdown-editor-container {
        display: block;
        margin-top: 10px;
    }
    
    .markdown-input {
        width: 100%;
        margin-bottom: 20px;
    }
    
    .markdown-preview-wrapper {
        width: 100%;
    }
    
    .markdown-preview {
        width: 100%;
        min-height: 300px;
        max-height: 600px;
        border: 1px solid #ddd;
        padding: 15px;
        background: white;
        overflow-y: auto;
        border-radius: 4px;
    }
    
    .field-content_md .vLargeTextField {
        width: 100% !important;
        min-height: 500px;
        font-family: 'Courier New', monospace;
        resize: vertical;
    }
    
    .preview-label {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }
    
    .preview-loading {
        color: #999;
        font-style: italic;
    }
    
    /* Fullscreen editor button */
    .fullscreen-btn {
        display: block;
        background: #417690;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 10px;
        font-size: 13px;
    }
    
    .fullscreen-btn:hover {
        background: #205067;
    }
    
    /* Fullscreen overlay */
    .fullscreen-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: #f8f8f8;
        z-index: 10000;
        padding: 20px;
    }
    
    .fullscreen-overlay.active {
        display: flex;
        flex-direction: column;
    }
    
    .fullscreen-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #ddd;
    }
    
    .fullscreen-title {
        font-size: 18px;
        font-weight: bold;
        color: #333;
    }
    
    .fullscreen-close {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
    }
    
    .fullscreen-close:hover {
        background: #c82333;
    }
    
    .fullscreen-content {
        display: flex;
        gap: 20px;
        flex: 1;
        min-height: 0;
    }
    
    .fullscreen-editor {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
    }
    
    .fullscreen-editor textarea {
        width: 100%;
        height: 100%;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: none;
    }
    
    .fullscreen-preview-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        min-width: 0;
    }
    
    .fullscreen-preview {
        flex: 1;
        border: 1px solid #ddd;
        padding: 15px;
        background: white;
        overflow-y: auto;
        border-radius: 4px;
    }
    
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentField = document.querySelector('#id_content_md');
    
    if (contentField) {
        // Store original parent before any DOM manipulation
        const originalParent = contentField.parentNode;
        
        // Create preview container (stacked layout)
        const previewContainer = document.createElement('div');
        previewContainer.className = 'markdown-editor-container';
        
        // Create fullscreen button
        const fullscreenBtn = document.createElement('button');
        fullscreenBtn.type = 'button';
        fullscreenBtn.className = 'fullscreen-btn';
        fullscreenBtn.textContent = '⛶ Fullscreen Editor';
        
        // Wrap the textarea
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'markdown-input';
        
        // Create preview pane wrapper
        const previewWrapper = document.createElement('div');
        previewWrapper.className = 'markdown-preview-wrapper';
        previewWrapper.innerHTML = '<div class="preview-label">Preview:</div><div class="markdown-preview markdown-content"></div>';
        
        // Create fullscreen overlay
        const fullscreenOverlay = document.createElement('div');
        fullscreenOverlay.className = 'fullscreen-overlay';
        fullscreenOverlay.innerHTML = `
            <div class="fullscreen-header">
                <div class="fullscreen-title">Markdown Editor - Fullscreen Mode</div>
                <button type="button" class="fullscreen-close">✕ Close (ESC)</button>
            </div>
            <div class="fullscreen-content">
                <div class="fullscreen-editor">
                    <div class="preview-label">Editor:</div>
                    <textarea class="fullscreen-textarea"></textarea>
                </div>
                <div class="fullscreen-preview-container">
                    <div class="preview-label">Preview:</div>
                    <div class="fullscreen-preview markdown-content"></div>
                </div>
            </div>
        `;
        
        // Insert container where the contentField currently is
        originalParent.insertBefore(previewContainer, contentField);
        
        // Build the structure
        inputWrapper.appendChild(fullscreenBtn);
        inputWrapper.appendChild(contentField);
        previewContainer.appendChild(inputWrapper);
        previewContainer.appendChild(previewWrapper);
        
        // Add fullscreen overlay to body
        document.body.appendChild(fullscreenOverlay);
        
        const preview = previewWrapper.querySelector('.markdown-preview');
        const fullscreenTextarea = fullscreenOverlay.querySelector('.fullscreen-textarea');
        const fullscreenPreview = fullscreenOverlay.querySelector('.fullscreen-preview');
        const fullscreenClose = fullscreenOverlay.querySelector('.fullscreen-close');
        
        // Debounce function
        let debounceTimer;
        function debounce(func, delay) {
            return function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(func, delay);
            };
        }
        
        // Get CSRF token from Django's form
        function getCSRFToken() {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            return csrfInput ? csrfInput.value : '';
        }
        
        // Update preview function (works for both normal and fullscreen)
        function updatePreview(targetPreview) {
            const markdownText = contentField.value;
            const previewElement = targetPreview || preview;
            
            if (!markdownText) {
                previewElement.innerHTML = '<em style="color: #999;">Preview will appear here...</em>';
                if (targetPreview === fullscreenPreview) {
                    preview.innerHTML = '<em style="color: #999;">Preview will appear here...</em>';
                }
                return;
            }
            
            previewElement.innerHTML = '<span class="preview-loading">Updating preview...</span>';
            
            fetch('/admin/preview-markdown/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                credentials: 'same-origin',
                body: JSON.stringify({ markdown: markdownText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    previewElement.innerHTML = data.html;
                    // Update both previews if in fullscreen mode
                    if (fullscreenOverlay.classList.contains('active')) {
                        if (targetPreview === fullscreenPreview) {
                            preview.innerHTML = data.html;
                        } else {
                            fullscreenPreview.innerHTML = data.html;
                        }
                    }
                } else if (data.error) {
                    previewElement.innerHTML = '<em style="color: red;">Error: ' + data.error + '</em>';
                }
            })
            .catch(error => {
                console.error('Preview error:', error);
                previewElement.innerHTML = '<em style="color: red;">Failed to update preview</em>';
            });
        }
        
        // Fullscreen toggle functions
        function openFullscreen() {
            fullscreenOverlay.classList.add('active');
            fullscreenTextarea.value = contentField.value;
            updatePreview(fullscreenPreview);
            fullscreenTextarea.focus();
        }
        
        function closeFullscreen() {
            fullscreenOverlay.classList.remove('active');
            contentField.value = fullscreenTextarea.value;
            updatePreview(preview);
            contentField.focus();
        }
        
        // Sync content between normal and fullscreen editors
        function syncToFullscreen() {
            if (fullscreenOverlay.classList.contains('active')) {
                fullscreenTextarea.value = contentField.value;
                updatePreview(fullscreenPreview);
            }
        }
        
        function syncFromFullscreen() {
            contentField.value = fullscreenTextarea.value;
            updatePreview(preview);
        }
        
        // Event listeners
        fullscreenBtn.addEventListener('click', openFullscreen);
        fullscreenClose.addEventListener('click', closeFullscreen);
        
        // ESC key to close fullscreen
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && fullscreenOverlay.classList.contains('active')) {
                closeFullscreen();
            }
        });
        
        // Initial preview
        updatePreview();
        
        // Update preview on input with debounce
        const debouncedUpdate = debounce(updatePreview, 300);
        const debouncedFullscreenUpdate = debounce(() => {
            syncFromFullscreen();
        }, 300);
        
        contentField.addEventListener('input', debouncedUpdate);
        contentField.addEventListener('change', updatePreview);
        
        fullscreenTextarea.addEventListener('input', debouncedFullscreenUpdate);
        fullscreenTextarea.addEventListener('change', () => {
            syncFromFullscreen();
        });
    }
});
</script>
{% endblock %}