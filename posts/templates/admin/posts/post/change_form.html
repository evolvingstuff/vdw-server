{% extends "admin/change_form.html" %}
{% load static %}

{% block extrahead %}
{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% static 'posts/css/markdown-content.css' %}">
<style>
    .markdown-editor-container {
        display: block;
        margin-top: 10px;
    }
    
    .markdown-input {
        width: 100%;
        margin-bottom: 20px;
    }
    
    .markdown-preview {
        width: 100%;
        min-height: 300px;
        max-height: 600px;
        border: 1px solid #ddd;
        padding: 15px;
        background: white;
        overflow-y: auto;
        border-radius: 4px;
    }
    
    .field-content_md .vLargeTextField {
        width: 100% !important;
        min-height: 500px;
        font-family: 'Courier New', monospace;
    }
    
    .preview-label {
        font-weight: bold;
        margin-bottom: 10px;
        color: #333;
    }
    
    .preview-loading {
        color: #999;
        font-style: italic;
    }
    
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const contentField = document.querySelector('#id_content_md');
    
    if (contentField) {
        // Create preview container
        const previewContainer = document.createElement('div');
        previewContainer.className = 'markdown-editor-container';
        
        // Wrap the textarea
        const inputWrapper = document.createElement('div');
        inputWrapper.className = 'markdown-input';
        
        // Create preview pane
        const previewPane = document.createElement('div');
        previewPane.innerHTML = '<div class="preview-label">Preview:</div><div class="markdown-preview markdown-content"></div>';
        
        // Rearrange elements
        contentField.parentNode.insertBefore(previewContainer, contentField);
        inputWrapper.appendChild(contentField);
        previewContainer.appendChild(inputWrapper);
        previewContainer.appendChild(previewPane);
        
        const preview = previewPane.querySelector('.markdown-preview');
        
        // Debounce function
        let debounceTimer;
        function debounce(func, delay) {
            return function() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(func, delay);
            };
        }
        
        // Get CSRF token from Django's form
        function getCSRFToken() {
            const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
            return csrfInput ? csrfInput.value : '';
        }
        
        // Update preview function
        function updatePreview() {
            const markdownText = contentField.value;
            
            if (!markdownText) {
                preview.innerHTML = '<em style="color: #999;">Preview will appear here...</em>';
                return;
            }
            
            preview.innerHTML = '<span class="preview-loading">Updating preview...</span>';
            
            fetch('/admin/preview-markdown/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                credentials: 'same-origin',
                body: JSON.stringify({ markdown: markdownText })
            })
            .then(response => response.json())
            .then(data => {
                if (data.html) {
                    preview.innerHTML = data.html;
                } else if (data.error) {
                    preview.innerHTML = '<em style="color: red;">Error: ' + data.error + '</em>';
                }
            })
            .catch(error => {
                console.error('Preview error:', error);
                preview.innerHTML = '<em style="color: red;">Failed to update preview</em>';
            });
        }
        
        // Initial preview
        updatePreview();
        
        // Update preview on input with debounce
        const debouncedUpdate = debounce(updatePreview, 300);
        contentField.addEventListener('input', debouncedUpdate);
        contentField.addEventListener('change', updatePreview);
    }
});
</script>
{% endblock %}